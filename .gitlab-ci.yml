stages:
  - update
  - prepare
  - build
  - deploy
update:
  stage: update
  only:
    - master
  tags:
    - WalkAndroidRunner
  script:
   - bundle install 
   - bundle update fastlane
  interruptible: true

create_property_files:
  stage: prepare
  variables: 
    SECURE_FILES_DOWNLOAD_PATH : $pwd
  only:
    - master
  script:
    - curl -s https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer | bash
    - ls 
    # - Rename-Item upload-keystore.jsk 
    # - echo $KEYSTORE | base64 -d > my.keystore
    - echo "storeFile=upload-keystore.jks" > key.properties
    - echo "storePassword=$KEYSTORE_PASSWORD" >> key.properties
    - echo "keyAlias=$ALIAS" >> key.properties
    - echo "keyPassword=$KEY_PASSWORD" >> key.properties
  artifacts:
    paths:
      - upload-keystore.jks
      - keytest.properties
    expire_in: 10 mins


android:build:
  stage: build
  tags:
    - WalkAndroidRunner
  before_script:
    - fastlane env --capture_output
    - set FLUTTER_PATH= C:/flutter/bin/flutter
    - set ANDROID_SDK_ROOT=C:/Users/EASHUBH THAPLIYAL/AppData/Local/Android/sdk
  script:
    - cd android
    - fastlane build_android 
  artifacts:
    paths:
    - build/app/outputs/apk/release/app-release.apk
    - build/app/outputs/bundle/release/app-release.aab
    expire_in: 1 week
  interruptible: true

z:internal:android:deploy:
  stage: deploy
  tags:
    - WalkAndroidRunner
  script:
    - cd android
    - fastlane deploy_android track:internal
  dependencies:
    - android:build